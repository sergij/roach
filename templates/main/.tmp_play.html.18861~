{% extends "game_base.html" %}
{% block head %}
<script type="text/javascript">	
function next() {
$.post("/game/next/", { play: {{ play.id }} });
$("#my_used").text('');
$("#en_used").text('');
play();
}

function bju(id) {
$.post("/game/bju/", {id : id , play: {{ play.id }} },
function(data){
if (data[0].denied == true){
		alert("Не правильно ходиш!");
	}
  }
, "json");
 play();
}

function beru(id) {
$.post("/game/beru/", {play: {{ play.id }} },
function(data){
		$("#my_used").text('');
		$("#en_used").text('');
	}
  , "json");
  play();
}

function give(id) {
$.post("/game/give/", {id : id , play: {{ play.id }} },
function(data){
	if (data[0].denied == true){
		alert("Не правильно ходиш!");
	}
  }
, "json");
  	play();
}

function play() {
  $.post("/game/play/" + {{ play.id }} + "/", { user: {{ user.id }} },
  function(data){
	status = $("#status").val();
	if (data[0].abort == true){
		parent.location='/game/';
		alert("Ваш противник не-хо");
	}
  	if (data[0].wait == false && data[0].abort == false && status == "false")
	{
		cards = data[0].cards
		if (data[0].current == {{ user.gamer.id }})
		{
			s = '';
			for (i = 0; i < cards.length; i++){
				s += "<p>" + cards[i] + " " + "<input type=\"button\" onclick=\"give(" + i + ")\" value=\"Хожу\"/></p>"
			}
			s += "<input type=\"button\" onclick=\"next()\" value=\"Не хожу\"/>"
		}
		else{
			s = '';
			for (i = 0; i < cards.length; i++){
				s += "<p>" + cards[i] + " " + "<input type=\"button\" onclick=\"bju(" + i + ")\" value=\"Бью\"/></p>"
			}
			s += "<input type=\"button\" onclick=\"beru()\" value=\"Беру\"/>"
		}
		$("#cards").text("")
		$("#cards").append(s)
		s='';
		$('#timer').stopTime('timer');
		$('#timer').text(60)
		$('#timer').everyTime("1s", 'timer', function(i) {
		   $(this).text(60-i);
		}, 61);
		$("#gamers").text("")
		
    	$("#ingame").stopTime('wait');
		
		s = "<input type=\"button\" onclick=\"next()\" value=\"Next\"/>"
		s += "<input type=\"hidden\" id=\"status\" value=\"true\"/>"
		$("#gamers").append(s)
	}
  	else if (data[0].wait == true && data[0].abort == false && status == "true") {	
		cards = data[0].cards
		if (data[0].current == {{ user.gamer.id }})
		{
			s = '';
			for (i = 0; i < cards.length; i++){
				s += "<p>" + cards[i] + " " + "<input type=\"button\" onclick=\"give(" + i + ")\" value=\"Хожу\"/></p>"
			}
			s += "<input type=\"button\" onclick=\"next()\" value=\"Не хожу\"/>"
		}
		else{
			s = '';
			for (i = 0; i < cards.length; i++){
				s += "<p>" + cards[i] + " " + "<input type=\"button\" onclick=\"bju(" + i + ")\" value=\"Бью\"/></p>"
			}
			s += "<input type=\"button\" onclick=\"beru()\" value=\"Беру\"/>"
		}
		$("#cards").text("")
		$("#cards").append(s)
		s='';
		$('#timer').stopTime('timer');
		$('#timer').text(60)
		$('#timer').everyTime("1s", 'timer', function(i) {
		    $(this).text(60-i);
		}, 61);
		$("#gamers").text("")
		s = "<input type=\"button\" disabled value=\"Next\"/>"
		s += "<input type=\"hidden\" id=\"status\" value=\"false\"/>"
		$("#gamers").append(s);
		s='';
		$("#ingame").everyTime("5s", 'wait', function(i) {
	    play()
    }, 0);
	}
	en_cards = data[0].en_cards
	my_cards = data[0].my_used
	if (en_cards.length>0){
		$("#en_used").text("O'походил:");
		s = '';
		for (i = 0; i < en_cards.length; i++){
			s += "<p>" + en_cards[i] + "</p>";
		}
		$("#en_used").append(s);
	}
	else{
		$("#en_used").text("");
		$("#my_used").text("");
	}	
	if (my_cards.length>0){
		$("#my_used").text('Я походил:');
		s = '';
		for (i = 0; i < my_cards.length; i++){
			s += "<p>" + my_cards[i] + "</p>";
		}
		$("#my_used").append(s);
	}
	else{
		$("#my_used").text("");
	}
    }
  , "json");
}

$(document).ready(function(){
	$("#ingame").everyTime("5s", 'wait', function(i) {
	    play()
    }, 0);
    
	$("#ingame").oneTime("2s", function() {
    play()
    });
	
		$("#ingame2").everyTime("1s", 'timer', function(i) {
            $(this).text(60-i);
        }, 63);
    
	$("#start").click(function() {
        $("#example_2").everyTime("5s", 'timer2', function(i) {
            $(this).text(5*i);
        }, 15);
    });
    
    $("#stop").click(function() {
        $("#example_2").stopTime('timer2');
    });
	
	//$("#hr").oneTime("60s", function() {
    //    $(this).hide(2500);
    //});
});
</script>

{% endblock %}

{% block title %}In Play{% endblock %}

{% block content %}
<h1 align='center'>"Пиковая Дама..."</h1>

<a href="/">Домой</a>

<div align="center" id="gamers">
<input type="hidden" id="status" value="false"/>
</div>
<hidden id="ingame"/>

<div align="right" id="user">
<form method="post" action="/game/">
{% csrf_token %}
<input type="hidden" name="play" value={{ play.id }} />
<input type="submit" value="Набридло грати"/>
</form>
<p id="timer">
Ожидаем активности противника, кароче втычим
</p>	
</div>
<div align="center">
<table align="center">
<tr>
<td  valign="top">
<div align="left" id="cards">

</div>
</td>
<td  valign="top">
<div align="center" id="my_used">

</div>
</td>
<td valign="top">
<div align="right" id="en_used">

</div>
</td>
</tr>
</table>
</div>
{% endblock %}
